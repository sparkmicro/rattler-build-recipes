context:
  name: gcc-arm-none-eabi
  version: "10.3.2021.10"
  
package:
  name: ${{ name }}
  version: ${{ version }}

source:
  # Linux (x86_64)
  - if: linux and x86_64
    then:
      url: https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases/download/v10.3.1-2.3/xpack-arm-none-eabi-gcc-10.3.1-2.3-linux-x64.tar.gz
      sha256: 559dcf1c2dfddac513110fe23da0ef254032c09967eaa901f075515d51818719

  # Linux (AArch64)
  - if: linux and aarch64
    then:
      url: https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases/download/v10.3.1-2.3/xpack-arm-none-eabi-gcc-10.3.1-2.3-linux-arm64.tar.gz
      sha256: 6e3ee605079ba084836cd057022e16c28605f4068042cd14397976b836ea1a21

  # macOS (x86_64)
  - if: osx
    then:
      url: https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases/download/v10.3.1-2.3/xpack-arm-none-eabi-gcc-10.3.1-2.3-darwin-x64.tar.gz
      sha256: eb9218eaafb74a05fab9cbbeb49fd4fe7b85c6ba411aefc66f681a5a862e8d8e

  # Windows
  - if: win
    then:
      url: https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases/download/v10.3.1-2.3/xpack-arm-none-eabi-gcc-10.3.1-2.3-win32-x64.zip
      sha256: 169744f784fb04ae10c60bc6a2cd69cff93cff0bf5657e9333776036f347f9c4

build:
  number: 3
  script:
    - if: unix
      then: |
        # Enter directory if it exists
        if ls -d gcc-arm-none-eabi-* 1> /dev/null 2>&1; then
          cd gcc-arm-none-eabi-*
        elif ls -d arm-gnu-toolchain-* 1> /dev/null 2>&1; then
          cd arm-gnu-toolchain-*
        elif ls -d xpack-arm-none-eabi-gcc-* 1> /dev/null 2>&1; then
          cd xpack-arm-none-eabi-gcc-*
        fi

        mkdir -p $PREFIX/bin
        mkdir -p $PREFIX/lib
        mkdir -p $PREFIX/share
        mkdir -p $PREFIX/arm-none-eabi
        
        cp -r bin/* $PREFIX/bin/
        cp -r lib/* $PREFIX/lib/
        cp -r share/* $PREFIX/share/
        cp -r arm-none-eabi/* $PREFIX/arm-none-eabi/
        
        if [ -d "libexec" ]; then
          mkdir -p $PREFIX/libexec
          cp -r libexec/* $PREFIX/libexec/
        fi

        if [ "$(uname)" = "Linux" ]; then
            cd $PREFIX/lib
            ln -sf libtinfo.so.6 libtinfo.so.5
            ln -sf libncurses.so.6 libncurses.so.5
            cd - > /dev/null
        fi

    - if: win
      then: |
        REM Find the directory (xPack extracts to a subdir) and enter it
        for /d %%D in (xpack-arm-none-eabi-gcc-*) do cd %%D
        for /d %%D in (gcc-arm-none-eabi-*) do cd %%D
        for /d %%D in (arm-gnu-toolchain-*) do cd %%D

        if not exist "%PREFIX%\\bin" mkdir "%PREFIX%\\bin"
        if not exist "%PREFIX%\\lib" mkdir "%PREFIX%\\lib"
        if not exist "%PREFIX%\\share" mkdir "%PREFIX%\\share"
        if not exist "%PREFIX%\\arm-none-eabi" mkdir "%PREFIX%\\arm-none-eabi"

        xcopy /s /y /i bin "%PREFIX%\\bin"
        xcopy /s /y /i lib "%PREFIX%\\lib"
        xcopy /s /y /i share "%PREFIX%\\share"
        xcopy /s /y /i arm-none-eabi "%PREFIX%\\arm-none-eabi"
        
        if exist "libexec" (
          if not exist "%PREFIX%\\libexec" mkdir "%PREFIX%\\libexec"
          xcopy /s /y /i libexec "%PREFIX%\\libexec"
        )

requirements:
  build:
    - make  # [unix]
  run:
    # Required for the symlink fix to work (provides libtinfo.so.6)
    - if: linux
      then:
        - ncurses